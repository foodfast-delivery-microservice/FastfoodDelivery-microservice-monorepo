services:
  # 1. Service Registry (Eureka)
  registry-service:
    build: ./services/registry-service
    container_name: registry-service
    ports:
      - "8761:8761"

  # 2. Database (MySQL)
  mysql-db:
    image: mysql:8.0
    container_name: mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: 1234
      MYSQL_DATABASE: userservice
    #      MYSQL_USER: root
    #      MYSQL_PASSWORD: password
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d # Chạy script tạo các DB
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      timeout: 20s
      retries: 10

  # 3. Message Broker (RabbitMQ)
  rabbitmq-broker:
    image: rabbitmq:3.13-management
    container_name: rabbitmq-broker
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  # 4. API Gateway
  gateway-service:
    build: ./services/gateway-service
    container_name: gateway-service
    ports:
      - "8080:8080"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      APP_JWT_SECRETKEY: g5rhnoLF2O4S/p5wPKY9ojbK3X2g6ifB6cG9lkaLUg9quMDtO1PSI4J6biyJHZ5uAnyTbuTyaWRpHy+BADU7NQ==
    depends_on:
      registry-service:
        condition: service_started

  # 5. User Service
  user-service:
    build: ./services/user-microservice
    container_name: user-service
    ports:
      - "8081:8081"
    environment:
      # Sử dụng Railway DB nếu có biến môi trường RAILWAY_MYSQL_HOST, nếu không thì dùng local MySQL
      # Để dùng Railway: tạo file .env với RAILWAY_MYSQL_HOST, RAILWAY_MYSQL_PORT, RAILWAY_MYSQL_USER, RAILWAY_MYSQL_PASSWORD
      SPRING_DATASOURCE_URL: ${RAILWAY_DATASOURCE_URL:-jdbc:mysql://mysql-db:3306/userservice}
      SPRING_DATASOURCE_USERNAME: ${RAILWAY_MYSQL_USER:-root}
      SPRING_DATASOURCE_PASSWORD: ${RAILWAY_MYSQL_PASSWORD:-1234}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      SPRING_RABBITMQ_HOST: rabbitmq-broker
      APP_JWT_SECRETKEY: g5rhnoLF2O4S/p5wPKY9ojbK3X2g6ifB6cG9lkaLUg9quMDtO1PSI4J6biyJHZ5uAnyTbuTyaWRpHy+BADU7NQ==
    depends_on:
      registry-service:
        condition: service_started
      mysql-db:
        condition: service_healthy
      rabbitmq-broker:
        condition: service_started

  # 6. Product Service
  product-service:
    build: ./services/product-microservice
    container_name: product-service
    ports:
      - "8082:8082"
    environment:
      # Sử dụng Railway DB nếu có biến môi trường RAILWAY_DATASOURCE_URL_PRODUCT, nếu không thì dùng local MySQL
      SPRING_DATASOURCE_URL: ${RAILWAY_DATASOURCE_URL_PRODUCT:-jdbc:mysql://mysql-db:3306/productmicroservice}
      SPRING_DATASOURCE_USERNAME: ${RAILWAY_MYSQL_USER:-root}
      SPRING_DATASOURCE_PASSWORD: ${RAILWAY_MYSQL_PASSWORD:-1234}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      APP_JWT_SECRETKEY: g5rhnoLF2O4S/p5wPKY9ojbK3X2g6ifB6cG9lkaLUg9quMDtO1PSI4J6biyJHZ5uAnyTbuTyaWRpHy+BADU7NQ==
      SPRING_RABBITMQ_HOST: rabbitmq-broker
    depends_on:
      registry-service:
        condition: service_started
      mysql-db:
        condition: service_healthy
      rabbitmq-broker:
        condition: service_started

  # 7. Order Service
  order-service:
    build: ./services/order-microservice
    container_name: order-service
    ports:
      - "8083:8083"
    environment:
      # Sử dụng Railway DB nếu có biến môi trường RAILWAY_DATASOURCE_URL_ORDER, nếu không thì dùng local MySQL
      SPRING_DATASOURCE_URL: ${RAILWAY_DATASOURCE_URL_ORDER:-jdbc:mysql://mysql-db:3306/orderservice}
      SPRING_DATASOURCE_USERNAME: ${RAILWAY_MYSQL_USER:-root}
      SPRING_DATASOURCE_PASSWORD: ${RAILWAY_MYSQL_PASSWORD:-1234}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      SPRING_RABBITMQ_HOST: rabbitmq-broker
    depends_on:
      registry-service:
        condition: service_started
      mysql-db:
        condition: service_healthy
      rabbitmq-broker:
        condition: service_started

  # 8. Payment service
  payment-service:
    build: ./services/payment-microservice
    container_name: payment-service
    ports:
      - "8084:8084"
    environment:
      # Sử dụng Railway DB nếu có biến môi trường RAILWAY_DATASOURCE_URL_PAYMENT, nếu không thì dùng local MySQL
      SPRING_DATASOURCE_URL: ${RAILWAY_DATASOURCE_URL_PAYMENT:-jdbc:mysql://mysql-db:3306/paymentservice}
      SPRING_DATASOURCE_USERNAME: ${RAILWAY_MYSQL_USER:-root}
      SPRING_DATASOURCE_PASSWORD: ${RAILWAY_MYSQL_PASSWORD:-1234}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      SPRING_RABBITMQ_HOST: rabbitmq-broker
    depends_on:
      registry-service:
        condition: service_started
      mysql-db:
        condition: service_healthy
      rabbitmq-broker:
        condition: service_started

  drone-service:
    build: ./services/Drone-service
    container_name: drone-service
    ports:
      - "8085:8085"
    environment:
      # Sử dụng Railway DB nếu có biến môi trường RAILWAY_DATASOURCE_URL_DRONE, nếu không thì dùng local MySQL
      SPRING_DATASOURCE_URL: ${RAILWAY_DATASOURCE_URL_DRONE:-jdbc:mysql://mysql-db:3306/droneservice}
      SPRING_DATASOURCE_USERNAME: ${RAILWAY_MYSQL_USER:-root}
      SPRING_DATASOURCE_PASSWORD: ${RAILWAY_MYSQL_PASSWORD:-1234}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      SPRING_RABBITMQ_HOST: rabbitmq-broker
    depends_on:
      registry-service:
        condition: service_started
      mysql-db:
        condition: service_healthy
      rabbitmq-broker:
        condition: service_started

  # 9. Frontend Application
  frontend:
    build: ./frontend
    container_name: frontend
    ports:
      - "3000:80"
    depends_on:
      - gateway-service
    networks:
      - default

volumes:
  mysql-data:


networks:
  default:
    name: microservice-net
